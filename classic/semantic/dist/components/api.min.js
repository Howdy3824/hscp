!function(e,t,r,n){"use strict";t=void 0!==t&&t.Math==Math?t:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();e.api=e.fn.api=function(r){var o,s=e(e.isFunction(this)?t:this),i=s.selector||"",a=(new Date).getTime(),u=[],c=arguments[0],d="string"==typeof c,l=[].slice.call(arguments,1);return s.each(function(){var s,g,f,p,m,b=e.isPlainObject(r)?e.extend(!0,{},e.fn.api.settings,r):e.extend({},e.fn.api.settings),v=b.namespace,h=b.metadata,y=b.selector,q=b.error,R=b.className,x="."+v,S="module-"+v,A=e(this),k=A.closest(y.form),T=b.stateContext?e(b.stateContext):A,P=this,j=T[0],O=A.data(S);m={initialize:function(){d||m.bind.events(),m.instantiate()},instantiate:function(){m.verbose("Storing instance of module",m),O=m,A.data(S,O)},destroy:function(){m.verbose("Destroying previous module for",P),A.removeData(S).off(x)},bind:{events:function(){var e=m.get.event();e?(m.verbose("Attaching API events to element",e),A.on(e+x,m.event.trigger)):"now"==b.on&&(m.debug("Querying API endpoint immediately"),m.query())}},decode:{json:function(e){if(e!==n&&"string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}},read:{cachedResponse:function(e){var r;{if(t.Storage!==n)return r=sessionStorage.getItem(e),m.debug("Using cached response",e,r),r=m.decode.json(r);m.error(q.noStorage)}}},write:{cachedResponse:function(r,o){o&&""===o?m.debug("Response empty, not caching",o):t.Storage!==n?(e.isPlainObject(o)&&(o=JSON.stringify(o)),sessionStorage.setItem(r,o),m.verbose("Storing cached response for url",r,o)):m.error(q.noStorage)}},query:function(){if(m.is.disabled())m.debug("Element is disabled API request aborted");else{if(m.is.loading()){if(!b.interruptRequests)return void m.debug("Cancelling request, previous request is still pending");m.debug("Interrupting previous request"),m.abort()}if(b.defaultData&&e.extend(!0,b.urlData,m.get.defaultData()),b.serializeForm&&(b.data=m.add.formData(b.data)),!1===(g=m.get.settings()))return m.cancelled=!0,void m.error(q.beforeSend);if(m.cancelled=!1,(f=m.get.templatedURL())||m.is.mocked()){if((f=m.add.urlData(f))||m.is.mocked()){if(g.url=b.base+f,s=e.extend(!0,{},b,{type:b.method||b.type,data:void 0,url:b.base+f,beforeSend:b.beforeXHR,success:function(){},failure:function(){},complete:function(){}}),m.debug("Querying URL",s.url),m.verbose("Using AJAX settings",s),"local"===b.cache&&m.read.cachedResponse(f))return m.debug("Response returned from local cache"),m.request=m.create.request(),void m.request.resolveWith(j,[m.read.cachedResponse(f)]);b.throttle?b.throttleFirstRequest||m.timer?(m.debug("Throttling request",b.throttle),clearTimeout(m.timer),m.timer=setTimeout(function(){m.timer&&delete m.timer,m.debug("Sending throttled request",void 0,s.method),m.send.request()},b.throttle)):(m.debug("Sending request",void 0,s.method),m.send.request(),m.timer=setTimeout(function(){},b.throttle)):(m.debug("Sending request",void 0,s.method),m.send.request())}}else m.error(q.missingURL)}},should:{removeError:function(){return!0===b.hideError||"auto"===b.hideError&&!m.is.form()}},is:{disabled:function(){return A.filter(y.disabled).length>0},expectingJSON:function(){return"json"===b.dataType||"jsonp"===b.dataType},form:function(){return A.is("form")||T.is("form")},mocked:function(){return b.mockResponse||b.mockResponseAsync||b.response||b.responseAsync},input:function(){return A.is("input")},loading:function(){return!!m.request&&"pending"==m.request.state()},abortedRequest:function(e){return e&&e.readyState!==n&&0===e.readyState?(m.verbose("XHR request determined to be aborted"),!0):(m.verbose("XHR request was not aborted"),!1)},validResponse:function(t){return m.is.expectingJSON()&&e.isFunction(b.successTest)?(m.debug("Checking JSON returned success",b.successTest,t),b.successTest(t)?(m.debug("Response passed success test",t),!0):(m.debug("Response failed success test",t),!1)):(m.verbose("Response is not JSON, skipping validation",b.successTest,t),!0)}},was:{cancelled:function(){return m.cancelled||!1},succesful:function(){return m.request&&"resolved"==m.request.state()},failure:function(){return m.request&&"rejected"==m.request.state()},complete:function(){return m.request&&("resolved"==m.request.state()||"rejected"==m.request.state())}},add:{urlData:function(t,r){var o,s;return t&&(o=t.match(b.regExp.required),s=t.match(b.regExp.optional),r=r||b.urlData,o&&(m.debug("Looking for required URL variables",o),e.each(o,function(o,s){var i=-1!==s.indexOf("$")?s.substr(2,s.length-3):s.substr(1,s.length-2),a=e.isPlainObject(r)&&r[i]!==n?r[i]:A.data(i)!==n?A.data(i):T.data(i)!==n?T.data(i):r[i];if(a===n)return m.error(q.requiredParameter,i,t),t=!1,!1;m.verbose("Found required variable",i,a),a=b.encodeParameters?m.get.urlEncodedValue(a):a,t=t.replace(s,a)})),s&&(m.debug("Looking for optional URL variables",o),e.each(s,function(o,s){var i=-1!==s.indexOf("$")?s.substr(3,s.length-4):s.substr(2,s.length-3),a=e.isPlainObject(r)&&r[i]!==n?r[i]:A.data(i)!==n?A.data(i):T.data(i)!==n?T.data(i):r[i];a!==n?(m.verbose("Optional variable Found",i,a),t=t.replace(s,a)):(m.verbose("Optional variable not found",i),t=-1!==t.indexOf("/"+s)?t.replace("/"+s,""):t.replace(s,""))}))),t},formData:function(t){var r=e.fn.serializeObject!==n,o=r?k.serializeObject():k.serialize();return t=t||b.data,e.isPlainObject(t)?r?(m.debug("Extending existing data with form data",t,o),t=e.extend(!0,{},t,o)):(m.error(q.missingSerialize),m.debug("Cant extend data. Replacing data with form data",t,o),t=o):(m.debug("Adding form data",o),t=o),t}},send:{request:function(){m.set.loading(),m.request=m.create.request(),m.is.mocked()?m.mockedXHR=m.create.mockedXHR():m.xhr=m.create.xhr(),b.onRequest.call(j,m.request,m.xhr)}},event:{trigger:function(e){m.query(),"submit"!=e.type&&"click"!=e.type||e.preventDefault()},xhr:{always:function(){},done:function(t,r,n){var o=this,s=(new Date).getTime()-p,i=b.loadingDuration-s,a=!!e.isFunction(b.onResponse)&&(m.is.expectingJSON()?b.onResponse.call(o,e.extend(!0,{},t)):b.onResponse.call(o,t));i=i>0?i:0,a&&(m.debug("Modified API response in onResponse callback",b.onResponse,a,t),t=a),i>0&&m.debug("Response completed early delaying state change by",i),setTimeout(function(){m.is.validResponse(t)?m.request.resolveWith(o,[t,n]):m.request.rejectWith(o,[n,"invalid"])},i)},fail:function(e,t,r){var n=this,o=(new Date).getTime()-p,s=b.loadingDuration-o;(s=s>0?s:0)>0&&m.debug("Response completed early delaying state change by",s),setTimeout(function(){m.is.abortedRequest(e)?m.request.rejectWith(n,[e,"aborted",r]):m.request.rejectWith(n,[e,"error",t,r])},s)}},request:{done:function(e,t){m.debug("Successful API Response",e),"local"===b.cache&&f&&(m.write.cachedResponse(f,e),m.debug("Saving server response locally",m.cache)),b.onSuccess.call(j,e,A,t)},complete:function(e,t){var r,n;m.was.succesful()?(n=e,r=t):(r=e,n=m.get.responseFromXHR(r)),m.remove.loading(),b.onComplete.call(j,n,A,r)},fail:function(e,t,r){var o=m.get.responseFromXHR(e),i=m.get.errorFromRequest(o,t,r);if("aborted"==t)return m.debug("XHR Aborted (Most likely caused by page navigation or CORS Policy)",t,r),b.onAbort.call(j,t,A,e),!0;"invalid"==t?m.debug("JSON did not pass success test. A server-side error has most likely occurred",o):"error"==t&&e!==n&&(m.debug("XHR produced a server error",t,r),200!=e.status&&r!==n&&""!==r&&m.error(q.statusMessage+r,s.url),b.onError.call(j,i,A,e)),b.errorDuration&&"aborted"!==t&&(m.debug("Adding error state"),m.set.error(),m.should.removeError()&&setTimeout(m.remove.error,b.errorDuration)),m.debug("API Request failed",i,e),b.onFailure.call(j,o,A,e)}}},create:{request:function(){return e.Deferred().always(m.event.request.complete).done(m.event.request.done).fail(m.event.request.fail)},mockedXHR:function(){var t,r,n,o=b.mockResponse||b.response,s=b.mockResponseAsync||b.responseAsync;return n=e.Deferred().always(m.event.xhr.complete).done(m.event.xhr.done).fail(m.event.xhr.fail),o?(e.isFunction(o)?(m.debug("Using specified synchronous callback",o),r=o.call(j,g)):(m.debug("Using settings specified response",o),r=o),n.resolveWith(j,[r,!1,{responseText:r}])):e.isFunction(s)&&(t=function(e){m.debug("Async callback returned response",e),e?n.resolveWith(j,[e,!1,{responseText:e}]):n.rejectWith(j,[{responseText:e},!1,!1])},m.debug("Using specified async response callback",s),s.call(j,g,t)),n},xhr:function(){var t;return t=e.ajax(s).always(m.event.xhr.always).done(m.event.xhr.done).fail(m.event.xhr.fail),m.verbose("Created server request",t,s),t}},set:{error:function(){m.verbose("Adding error state to element",T),T.addClass(R.error)},loading:function(){m.verbose("Adding loading state to element",T),T.addClass(R.loading),p=(new Date).getTime()}},remove:{error:function(){m.verbose("Removing error state from element",T),T.removeClass(R.error)},loading:function(){m.verbose("Removing loading state from element",T),T.removeClass(R.loading)}},get:{responseFromXHR:function(t){return!!e.isPlainObject(t)&&(m.is.expectingJSON()?m.decode.json(t.responseText):t.responseText)},errorFromRequest:function(t,r,o){return e.isPlainObject(t)&&t.error!==n?t.error:b.error[r]!==n?b.error[r]:o},request:function(){return m.request||!1},xhr:function(){return m.xhr||!1},settings:function(){var t;return(t=b.beforeSend.call(j,b))&&(t.success!==n&&(m.debug("Legacy success callback detected",t),m.error(q.legacyParameters,t.success),t.onSuccess=t.success),t.failure!==n&&(m.debug("Legacy failure callback detected",t),m.error(q.legacyParameters,t.failure),t.onFailure=t.failure),t.complete!==n&&(m.debug("Legacy complete callback detected",t),m.error(q.legacyParameters,t.complete),t.onComplete=t.complete)),t===n&&m.error(q.noReturnedValue),!1===t?t:t!==n?e.extend(!0,{},t):e.extend(!0,{},b)},urlEncodedValue:function(e){var r=t.decodeURIComponent(e),n=t.encodeURIComponent(e);return r!==e?(m.debug("URL value is already encoded, avoiding double encoding",e),e):(m.verbose("Encoding value using encodeURIComponent",e,n),n)},defaultData:function(){var t={};return e.isWindow(P)||(m.is.input()?t.value=A.val():m.is.form()||(t.text=A.text())),t},event:function(){return e.isWindow(P)||"now"==b.on?(m.debug("API called without element, no events attached"),!1):"auto"==b.on?A.is("input")?P.oninput!==n?"input":P.onpropertychange!==n?"propertychange":"keyup":A.is("form")?"submit":"click":b.on},templatedURL:function(e){if(e=e||A.data(h.action)||b.action||!1,f=A.data(h.url)||b.url||!1)return m.debug("Using specified url",f),f;if(e){if(m.debug("Looking up url for action",e,b.api),b.api[e]===n&&!m.is.mocked())return void m.error(q.missingAction,b.action,b.api);f=b.api[e]}else m.is.form()&&(f=A.attr("action")||T.attr("action")||!1,m.debug("No url or action specified, defaulting to form action",f));return f}},abort:function(){var e=m.get.xhr();e&&"resolved"!==e.state()&&(m.debug("Cancelling API request"),e.abort())},reset:function(){m.remove.error(),m.remove.loading()},setting:function(t,r){if(m.debug("Changing setting",t,r),e.isPlainObject(t))e.extend(!0,b,t);else{if(r===n)return b[t];e.isPlainObject(b[t])?e.extend(!0,b[t],r):b[t]=r}},internal:function(t,r){if(e.isPlainObject(t))e.extend(!0,m,t);else{if(r===n)return m[t];m[t]=r}},debug:function(){!b.silent&&b.debug&&(b.performance?m.performance.log(arguments):(m.debug=Function.prototype.bind.call(console.info,console,b.name+":"),m.debug.apply(console,arguments)))},verbose:function(){!b.silent&&b.verbose&&b.debug&&(b.performance?m.performance.log(arguments):(m.verbose=Function.prototype.bind.call(console.info,console,b.name+":"),m.verbose.apply(console,arguments)))},error:function(){b.silent||(m.error=Function.prototype.bind.call(console.error,console,b.name+":"),m.error.apply(console,arguments))},performance:{log:function(e){var t,r;b.performance&&(r=(t=(new Date).getTime())-(a||t),a=t,u.push({Name:e[0],Arguments:[].slice.call(e,1)||"","Execution Time":r})),clearTimeout(m.performance.timer),m.performance.timer=setTimeout(m.performance.display,500)},display:function(){var t=b.name+":",r=0;a=!1,clearTimeout(m.performance.timer),e.each(u,function(e,t){r+=t["Execution Time"]}),t+=" "+r+"ms",i&&(t+=" '"+i+"'"),(console.group!==n||console.table!==n)&&u.length>0&&(console.groupCollapsed(t),console.table?console.table(u):e.each(u,function(e,t){console.log(t.Name+": "+t["Execution Time"]+"ms")}),console.groupEnd()),u=[]}},invoke:function(t,r,s){var i,a,u,c=O;return r=r||l,s=P||s,"string"==typeof t&&c!==n&&(t=t.split(/[\. ]/),i=t.length-1,e.each(t,function(r,o){var s=r!=i?o+t[r+1].charAt(0).toUpperCase()+t[r+1].slice(1):t;if(e.isPlainObject(c[s])&&r!=i)c=c[s];else{if(c[s]!==n)return a=c[s],!1;if(!e.isPlainObject(c[o])||r==i)return c[o]!==n?(a=c[o],!1):(m.error(q.method,t),!1);c=c[o]}})),e.isFunction(a)?u=a.apply(s,r):a!==n&&(u=a),e.isArray(o)?o.push(u):o!==n?o=[o,u]:u!==n&&(o=u),a}},d?(O===n&&m.initialize(),m.invoke(c)):(O!==n&&O.invoke("destroy"),m.initialize())}),o!==n?o:this},e.api.settings={name:"API",namespace:"api",debug:!1,verbose:!1,performance:!0,api:{},cache:!0,interruptRequests:!0,on:"auto",stateContext:!1,loadingDuration:0,hideError:"auto",errorDuration:2e3,encodeParameters:!0,action:!1,url:!1,base:"",urlData:{},defaultData:!0,serializeForm:!1,throttle:0,throttleFirstRequest:!0,method:"get",data:{},dataType:"json",mockResponse:!1,mockResponseAsync:!1,response:!1,responseAsync:!1,beforeSend:function(e){return e},beforeXHR:function(e){},onRequest:function(e,t){},onResponse:!1,onSuccess:function(e,t){},onComplete:function(e,t){},onFailure:function(e,t){},onError:function(e,t){},onAbort:function(e,t){},successTest:!1,error:{beforeSend:"The before send function has aborted the request",error:"There was an error with your request",exitConditions:"API Request Aborted. Exit conditions met",JSONParse:"JSON could not be parsed during error handling",legacyParameters:"You are using legacy API success callback names",method:"The method you called is not defined",missingAction:"API action used but no url was defined",missingSerialize:"jquery-serialize-object is required to add form data to an existing data object",missingURL:"No URL specified for api event",noReturnedValue:"The beforeSend callback must return a settings object, beforeSend ignored.",noStorage:"Caching responses locally requires session storage",parseError:"There was an error parsing your request",requiredParameter:"Missing a required URL parameter: ",statusMessage:"Server gave an error: ",timeout:"Your request timed out"},regExp:{required:/\{\$*[A-z0-9]+\}/g,optional:/\{\/\$*[A-z0-9]+\}/g},className:{loading:"loading",error:"error"},selector:{disabled:".disabled",form:"form"},metadata:{action:"action",url:"url"}}}(jQuery,window,document);